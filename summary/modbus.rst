
.. _modbus:

Modbus
===============

Modbus协议是一项应用层报文传输协议，包括ASCII、RTU、TCP三种报文类型。

标准的Modbus协议物理层接口有RS232、RS422、RS485和以太网接口，采用master/slave方式通信。

.. contents::
    :local:

Modbus RTU
-----------


Modbus TCP
-----------

odbusTCP的数据帧可分为两部分：MBAP+PDU。简单的理解，就是去掉了modbus协议本身的CRC校验，增加了MBAP报文头。

报文头MBAP
~~~~~~~~~~~~

MBAP为报文头，长度为7字节，组成如下：

* 事务元标识符（2个字节）：用于事务处理配对。在响应中，MODBUS服务器复制请求的事务处理标识符。这里在以太网传输中存在一个问题，就是先发后至，我们可以利用这个事务处理标识符做一个TCP序列号，来防止这种情况所造成的数据收发错乱（这里我们先不讨论这种情况，这个事务处理标识符我们统一使用0x00，0x01）
* 协议标识符（2个字节）：modbus协议标识符为0x00，0x00
* 长度（2个字节）：长度域是下一个域的字节数，包括单元标识符和数据域。
* 单元标识符（1个字节）：该设备的编号。（可以使用PLC的IP地址标识）。

帧结构PDU
~~~~~~~~~~~~

PDU由功能码+数据组成。功能码为1字节，数据长度不定，由具体功能决定。


通信方式
~~~~~~~~~~~~

Modbus设备可分为主站(poll)和从站(slave)。主站只有一个，从站有多个，主站向各从站发送请求帧，从站给予响应。在使用TCP通信时，主站为client端，主动建立连接；从站为server端，等待连接。

IANA（Internet Assigned Numbers Authority，互联网编号分配管理机构）给Modbus协议赋予TCP端口号为502，这是目前在仪表与自动化行业中唯一分配到的端口号。


通信过程
^^^^^^^^^^^^

* connect 建立TCP连接
* 准备Modbus报文
* 使用send命令发送报文
* 在同一连接下等待应答
* 使用recv命令读取报文，完成一次数据交换
* 通信任务结束时，关闭TCP连接
